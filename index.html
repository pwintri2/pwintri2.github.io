<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toegang</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f3f4f6; margin:0; display:grid; place-items:center; height:100vh;}
    .card{background:#fff; width:min(420px,92vw); padding:24px; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.06);}
    h1{margin:0 0 10px; font-size:20px;}
    p{margin:0 0 16px; color:#6b7280;}
    input{width:100%; font-size:18px; padding:12px 14px; border:1px solid #d1d5db; border-radius:10px; outline:none;}
    input:focus{border-color:#4f46e5; box-shadow:0 0 0 4px rgba(79,70,229,.12);}
    button{margin-top:12px; width:100%; padding:12px 14px; font-size:16px; border:0; border-radius:10px; background:#4f46e5; color:#fff; cursor:pointer;}
    button:active{transform:translateY(1px);}
    .msg{margin-top:12px; color:#ef4444; min-height:1.2em;}
    .small{margin-top:14px; color:#9ca3af; font-size:12px;}
    a{color:#4f46e5; text-decoration:none;}
  </style>
</head>
<body>
  <div class="card">
    <h1>Voer pincode in</h1>
    <p>Deze pagina is afgeschermd met een pincode.</p>

    <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="Pincode" />
    <button id="btn">Verder</button>
    <div id="msg" class="msg"></div>

    <div class="small">
      Beheer gebruikers/pincodes via <a href="gebruikers.html">gebruikers.html</a>
    </div>
  </div>

<script>
(function(){
  const DASHBOARD_URL = "Dasboard _ Wintrip Projects.html"; // exact jouw bestandsnaam
  const MAX_TRIES = 3;
  const LOCK_KEY = "wwp_lock_until";
  const TRIES_KEY = "wwp_login_tries";
  const USERS_KEY = "wwp_users";

  const $pin = document.getElementById("pin");
  const $msg = document.getElementById("msg");
  const $btn = document.getElementById("btn");

  function now(){ return Date.now(); }

  function getUsers(){
    // Default gebruiker als er nog niks is ingesteld:
    // -> verander dit pin: "1234" eventueel meteen.
    const fallback = [{ name: "Philip", pin: "1234" }];

    try{
      const raw = localStorage.getItem(USERS_KEY);
      if(!raw) return fallback;
      const list = JSON.parse(raw);
      if(!Array.isArray(list) || list.length === 0) return fallback;
      return list;
    }catch(e){
      return fallback;
    }
  }

  function isLocked(){
    const until = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
    return until && until > now();
  }

  function lockOut(seconds){
    localStorage.setItem(LOCK_KEY, String(now() + seconds*1000));
  }

  function resetTries(){
    localStorage.setItem(TRIES_KEY, "0");
  }

  function incTries(){
    const t = parseInt(localStorage.getItem(TRIES_KEY) || "0", 10) + 1;
    localStorage.setItem(TRIES_KEY, String(t));
    return t;
  }

  function attemptCloseTab(){
    // Dit werkt alleen betrouwbaar als het tabblad via script is geopend.
    // Fallback: we “leegmaken” de pagina zodat het effectief dicht voelt.
    try{
      window.open("", "_self");
      window.close();
    }catch(e){}
    setTimeout(()=>{ location.href = "about:blank"; }, 50);
  }

  function validate(pin){
    const users = getUsers();
    return users.some(u => String(u.pin) === String(pin).trim());
  }

  function go(){
    location.href = DASHBOARD_URL;
  }

  function updateLockedMessage(){
    const until = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
    const secs = Math.ceil((until - now()) / 1000);
    if(secs > 0){
      $msg.textContent = `Te vaak fout. Probeer over ${secs}s opnieuw.`;
      $btn.disabled = true;
      $pin.disabled = true;
    }else{
      $msg.textContent = "";
      $btn.disabled = false;
      $pin.disabled = false;
      localStorage.removeItem(LOCK_KEY);
    }
  }

  function onSubmit(){
    if(isLocked()){
      updateLockedMessage();
      return;
    }

    const pin = $pin.value;
    if(validate(pin)){
      resetTries();
      go();
      return;
    }

    $pin.value = "";
    $pin.focus();
    const tries = incTries();

    if(tries >= MAX_TRIES){
      $msg.textContent = "3x fout. Tabblad wordt gesloten…";
      // korte lock zodat refresh niet meteen weer kan
      lockOut(20);
      setTimeout(attemptCloseTab, 700);
    }else{
      $msg.textContent = `Onjuiste pincode. Poging ${tries}/${MAX_TRIES}.`;
    }
  }

  $btn.addEventListener("click", onSubmit);
  $pin.addEventListener("keydown", (e)=>{ if(e.key === "Enter") onSubmit(); });

  // init
  updateLockedMessage();
  if(isLocked()){
    const timer = setInterval(()=>{
      updateLockedMessage();
      if(!isLocked()) clearInterval(timer);
    }, 250);
  }
})();
</script>
</body>
</html>
